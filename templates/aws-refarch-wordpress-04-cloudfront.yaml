AWSTemplateFormatVersion: 2010-09-09

Description: Reference Architecture to host WordPress on AWS - Creates CloudFront distribution (if selected)

Metadata:
  Authors:
    Description: Darryl Osborne (darrylo@amazon.com)
  License:
    Description:
      'Copyright 2018 Amazon.com, Inc. and its affiliates. All Rights Reserved.
      Licensed under the Amazon Software License (the "License"). You may not use this file
      except in compliance with the License. A copy of the License is located at
      http://aws.amazon.com/asl/
      or in the "license" file accompanying this file. This file is distributed on an "AS IS"
      BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
      License for the specific language governing permissions and limitations under the License.'

  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: AWS Parameters
        Parameters:
          - WPDomainName
          - PublicAlbDnsName
          - OriginSSL
    ParameterLabels:
      PublicAlbDnsName:
        default: Public ALB DNS Name
      WPDomainName:
        default: Domain name of the WordPress site
      OriginSSL:
        default: Origin is using SSL?

Parameters:
  PublicAlbDnsName:
    Description: The public application load balancer dns name.
    Type: String
  WPDomainName:
    AllowedPattern: ^$|(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])$
    Description: '[ Optional ] The main domain name of the WordPress site (e.g. example.com).'
    Type: String
  OriginSSL:
    AllowedValues:
      - true
      - false
    Default: true
    Type: String

Conditions:
  WPDomainName: !Not [!Equals ['', !Ref WPDomainName]]
  OriginSSL: !Equals [true, !Ref OriginSSL]
  OriginNotSSL: !Not [!Equals [true, !Ref OriginSSL]]

Resources:
  CloudFront:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Aliases:
          - !If [
              WPDomainName,
              !Join ['', ['*.', !Ref WPDomainName]],
              !Ref 'AWS::NoValue',
            ]
        CacheBehaviors:
          - PathPattern: wp-includes/*
            AllowedMethods:
              - DELETE
              - GET
              - HEAD
              - OPTIONS
              - PATCH
              - POST
              - PUT
            DefaultTTL: 900
            MaxTTL: 900
            MinTTL: 900
            ForwardedValues:
              QueryString: true
              Headers:
                - Host
            TargetOriginId: elb
            ViewerProtocolPolicy: allow-all
            Compress: true
          - PathPattern: wp-content/*
            AllowedMethods:
              - DELETE
              - GET
              - HEAD
              - OPTIONS
              - PATCH
              - POST
              - PUT
            DefaultTTL: 900
            MaxTTL: 900
            MinTTL: 900
            ForwardedValues:
              QueryString: true
              Headers:
                - Host
            TargetOriginId: elb
            ViewerProtocolPolicy: allow-all
            Compress: true
        Comment: !Ref 'AWS::StackName'
        DefaultCacheBehavior:
          AllowedMethods:
            - DELETE
            - GET
            - HEAD
            - OPTIONS
            - PATCH
            - POST
            - PUT
          DefaultTTL: 0
          MaxTTL: 0
          MinTTL: 0
          ForwardedValues:
            QueryString: true
            Headers:
              - '*'
            Cookies:
              Forward: all
          TargetOriginId: elb
          ViewerProtocolPolicy: allow-all
          Compress: true
        Enabled: true
        Origins:
          - DomainName: !Ref PublicAlbDnsName
            Id: elb
            CustomOriginConfig:
              OriginProtocolPolicy: !If
                - OriginSSL
                - https-only
                - http-only
        PriceClass: PriceClass_100

Outputs:
  DnsEndpoint:
    Value: !GetAtt CloudFront.DomainName
  DnsHostname:
    Value:
      !If [
        OriginNotSSL,
        !Join ['', ['http://', !GetAtt CloudFront.DomainName]],
        !Join ['', ['https://', !GetAtt CloudFront.DomainName]],
      ]
